<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controller</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; background: #0f172a; color: #e2e8f0; }
    .wrap { max-width: 960px; margin: 0 auto; }
    .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 16px; }
    label { display: block; font-size: 14px; color: #94a3b8; margin-bottom: 6px; }
    input[type="text"], input[type="range"] { width: 100%; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background: #1f2937; border: 1px solid #374151; border-bottom-width: 3px; border-radius: 6px; padding: 2px 6px; }
    .status { color: #93c5fd; }
    .err { color: #fca5a5; }
    .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px; }
  </style>
  <script src="./config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    const url = new URL(location.href);
    const sessionId = url.searchParams.get('sid');
    const serverUrl = url.searchParams.get('server') || window.SERVER_URL || '';
    const socket = io(serverUrl || undefined);

    let input = { up: false, down: false, left: false, right: false, speed: 200 };
    let hasController = false;

    function sendInput() {
      socket.emit('control-update', { sessionId, input });
    }

    function setStatus(text, isError = false) {
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = isError ? 'err' : 'status';
    }

    window.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      if (e.key === 'ArrowUp' || e.key === 'w') input.up = true;
      if (e.key === 'ArrowDown' || e.key === 's') input.down = true;
      if (e.key === 'ArrowLeft' || e.key === 'a') input.left = true;
      if (e.key === 'ArrowRight' || e.key === 'd') input.right = true;
      sendInput();
    });
    window.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowUp' || e.key === 'w') input.up = false;
      if (e.key === 'ArrowDown' || e.key === 's') input.down = false;
      if (e.key === 'ArrowLeft' || e.key === 'a') input.left = false;
      if (e.key === 'ArrowRight' || e.key === 'd') input.right = false;
      sendInput();
    });

    window.addEventListener('load', () => {
      document.getElementById('sessionId').value = sessionId;
      document.getElementById('speed').addEventListener('input', (e) => {
        const v = Number(e.target.value);
        input.speed = v;
        document.getElementById('speedVal').textContent = v + ' px/s';
        sendInput();
      });

      socket.on('connect', () => {
        socket.emit('join-session', { sessionId, role: 'controller' });
      });
      socket.on('error-message', (msg) => setStatus(msg, true));
      socket.on('role-update', (data) => {
        hasController = data.hasController;
        setStatus(hasController ? 'Вы управляете мячом' : 'Ожидание контроллера...');
      });
      socket.on('ball-state', () => {
        // No canvas on controller; only sends input.
      });
    });
  </script>
  </head>
  <body>
    <div class="wrap">
      <h2>Контроллер сессии <span class="kbd" id="sessionId"></span></h2>
      <p id="status" class="status">Подключение...</p>

      <div class="grid">
        <div class="card">
          <label>Скорость мяча</label>
          <input id="speed" type="range" min="50" max="800" step="10" value="200" />
          <div id="speedVal" style="margin-top:8px">200 px/s</div>
        </div>

        <div class="card">
          <label>Управление</label>
          <div>Двигайте с помощью клавиш <span class="kbd">W A S D</span> или стрелок.</div>
        </div>
      </div>
    </div>
  </body>
  </html>


