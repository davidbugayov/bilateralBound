<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Viewer</title>
  <style>
    html, body { 
      height: 100%; 
      margin: 0; 
      padding: 0;
      overflow: hidden; 
      overflow-x: hidden;
      position: fixed;
      inset: 0;
      width: 100%;
      max-width: 100vw;
    }
    body { 
      background: #0f172a; 
      color: #e2e8f0; 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; 
    }
    #wrap { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; }
    canvas { 
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: #020617; 
      display: block; 
    }
    .overlay { position: fixed; top: 12px; left: 12px; background: rgba(2, 6, 23, 0.8); padding: 8px 12px; border-radius: 8px; border: 1px solid #1f2937; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background: #1f2937; border: 1px solid #374151; border-bottom-width: 3px; border-radius: 6px; padding: 2px 6px; }
  </style>
  <script src="./config.js?v=9"></script>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    const url = new URL(location.href);
    let sessionId = url.searchParams.get('sid');
    if (!sessionId) {
      const parts = location.pathname.split('/').filter(Boolean);
      sessionId = parts[parts.length - 1] || '';
    }
    const serverUrl = url.searchParams.get('server') || window.SERVER_URL || (location.hostname.endsWith('onrender.com') ? location.origin : '');
    const socket = io(serverUrl || undefined);

    // Ball state with interpolation for smooth movement
    let ball = { x: 300, y: 200, vx: 0, vy: 0 };
    let targetBall = { x: 300, y: 200, vx: 0, vy: 0 }; // Target position from server
    let hasController = false;
    
    // Interpolation settings
    const INTERPOLATION_FACTOR = 0.08; // Smoother interpolation factor
    const MIN_MOVEMENT_THRESHOLD = 0.05; // Smaller threshold for smoother movement

    function draw(ctx, w, h) {
      ctx.clearRect(0, 0, w, h);
      
      // Background color
      ctx.fillStyle = (ball.colorBg || '#020617');
      ctx.fillRect(0, 0, w, h);
      
      // Grid
      ctx.strokeStyle = '#0b1220';
      ctx.lineWidth = 1;
      for (let x = 0; x < w; x += 40) { 
        ctx.beginPath(); 
        ctx.moveTo(x, 0); 
        ctx.lineTo(x, h); 
        ctx.stroke(); 
      }
      for (let y = 0; y < h; y += 40) { 
        ctx.beginPath(); 
        ctx.moveTo(0, y); 
        ctx.lineTo(w, y); 
        ctx.stroke(); 
      }

      // Smooth ball rendering with anti-aliasing and interpolation
      const ballRadius = ball.radius || 40;
      
      // Interpolate ball position for smooth movement
      const dx = targetBall.x - ball.x;
      const dy = targetBall.y - ball.y;
      const distance = Math.sqrt(dx * dx + dy * dy);
      
      if (distance > MIN_MOVEMENT_THRESHOLD) {
        ball.x += dx * INTERPOLATION_FACTOR;
        ball.y += dy * INTERPOLATION_FACTOR;
      } else {
        ball.x = targetBall.x;
        ball.y = targetBall.y;
      }
      
      // Allow ball to move across the entire screen
      // Only clamp to prevent ball from going completely off-screen
      ball.x = Math.max(-ballRadius, Math.min(w + ballRadius, ball.x));
      ball.y = Math.max(-ballRadius, Math.min(h + ballRadius, ball.y));
      
      // Draw ball with enhanced anti-aliasing
      ctx.save();
      ctx.beginPath();
      ctx.fillStyle = (ball.colorBall || '#60a5fa');
      
      // Enable high-quality anti-aliasing
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      
      // Draw ball with shadow for better visibility
      ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
      ctx.shadowBlur = 4;
      ctx.shadowOffsetX = 1;
      ctx.shadowOffsetY = 1;
      
      ctx.arc(ball.x, ball.y, ballRadius, 0, Math.PI * 2);
      ctx.fill();
      
      // Remove shadow for clean edges
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
      
      ctx.restore();
      
      // Draw session ID in corner with better visibility
      ctx.fillStyle = '#94a3b8';
      ctx.font = '14px monospace';
      ctx.fillText(`Сессия: ${sessionId}`, 20, 30);
    }

    window.addEventListener('load', () => {
      const canvas = document.getElementById('cv');
      const ctx = canvas.getContext('2d');
      
      function size(){
        // Use actual visible canvas dimensions for proper ball movement
        const rect = canvas.getBoundingClientRect();
        const vw = rect.width;
        const vh = rect.height;
        canvas.width = vw;
        canvas.height = vh;
        
        // Report the current canvas size to the server so it can adjust world bounds
        socket.emit('world-size', { sessionId, width: canvas.width, height: canvas.height });
        console.log('Viewer sending world size:', canvas.width, 'x', canvas.height);
      }
      size(); 
      
      // Handle window resize and orientation change
      window.addEventListener('resize', size);
      window.addEventListener('orientationchange', () => {
        setTimeout(size, 100); // Delay to ensure orientation change is complete
      });

      // Ultra-smooth animation with optimized frame rate
      let lastTime = 0;
      const targetFPS = 60;
      const frameInterval = 1000 / targetFPS;
      
      function raf(currentTime) {
        if (currentTime - lastTime >= frameInterval) {
          draw(ctx, canvas.width, canvas.height);
          lastTime = currentTime;
        }
        requestAnimationFrame(raf);
      }
      requestAnimationFrame(raf);

      socket.on('connect', () => {
        socket.emit('join-session', { sessionId, role: 'viewer' });
        socket.emit('world-size', { sessionId, width: canvas.width, height: canvas.height });
      });
      
      socket.on('error-message', (msg) => {
        document.getElementById('msg').textContent = msg;
      });
      
      socket.on('role-update', (data) => {
        hasController = data.hasController;
        const messageEl = document.getElementById('msg');
        messageEl.textContent = data.message || (hasController ? 'Контроллер подключен' : 'Ожидание контроллера...');
        messageEl.style.color = hasController ? '#10b981' : '#f59e0b';
      });
      
      socket.on('ball-state', (state) => {
        // Update target position for smooth interpolation
        targetBall = { ...state };
        
        // Update ball properties that don't need interpolation
        ball.colorBall = state.colorBall;
        ball.colorBg = state.colorBg;
        ball.radius = state.radius;
      });
      
      socket.on('session-expired', (data) => {
        document.getElementById('msg').textContent = data.message;
        document.getElementById('msg').style.color = '#ef4444';
      });
      
      socket.on('controller-disconnected', (data) => {
        const messageEl = document.getElementById('msg');
        messageEl.textContent = data.message;
        messageEl.style.color = '#ef4444';
        
        // Show reconnection message
        setTimeout(() => {
          messageEl.textContent = 'Ожидание подключения контроллера...';
          messageEl.style.color = '#f59e0b';
        }, 3000);
      });
      
      socket.on('error-message', (message) => {
        const messageEl = document.getElementById('msg');
        messageEl.textContent = `Ошибка: ${message}`;
        messageEl.style.color = '#ef4444';
        
        // Clear error after 5 seconds
        setTimeout(() => {
          if (messageEl.style.color === '#ef4444') {
            messageEl.textContent = hasController ? 'Контроллер подключен' : 'Ожидание контроллера...';
            messageEl.style.color = hasController ? '#10b981' : '#f59e0b';
          }
        }, 5000);
      });
      
      document.getElementById('sid').textContent = sessionId;
    });
  </script>
  </head>
  <body>
    <div class="overlay">Сессия <span class="kbd" id="sid"></span> — <span id="msg">Подключение...</span></div>
    <canvas id="cv"></canvas>
  </body>
  </html>


