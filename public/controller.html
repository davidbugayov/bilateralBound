<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controller</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; background: #0f172a; color: #e2e8f0; }
    .wrap { max-width: 960px; margin: 0 auto; }
    .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 16px; }
    label { display: block; font-size: 14px; color: #94a3b8; margin-bottom: 6px; }
    input[type="text"], input[type="range"] { width: 100%; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background: #1f2937; border: 1px solid #374151; border-bottom-width: 3px; border-radius: 6px; padding: 2px 6px; }
    .status { color: #93c5fd; }
    .err { color: #fca5a5; }
    .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px; }
  </style>
  <script src="./config.js?v=4"></script>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    const url = new URL(location.href);
    const sessionId = url.searchParams.get('sid');
    const serverUrl = url.searchParams.get('server') || window.SERVER_URL || '';
    const socket = io(serverUrl || undefined);

    let hasController = false;
    let keyState = { up:false, down:false, left:false, right:false };
    let mul = 1;

    function emitDirection() {
      const dirX = (keyState.right ? 1 : 0) + (keyState.left ? -1 : 0);
      const dirY = (keyState.down ? 1 : 0) + (keyState.up ? -1 : 0);
      socket.emit('control-update', { sessionId, input: { dirX, dirY, speedMultiplier: mul } });
    }
    function pressDir(dx, dy) {
      socket.emit('control-update', { sessionId, input: { dirX: dx, dirY: dy, speedMultiplier: mul } });
    }
    function setMul(m) { mul = m; document.getElementById('speedVal').textContent = 'x' + m; }

    function setStatus(text, isError = false) {
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = isError ? 'err' : 'status';
    }

    window.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      if (e.key === 'ArrowUp' || e.key === 'w') keyState.up = true;
      if (e.key === 'ArrowDown' || e.key === 's') keyState.down = true;
      if (e.key === 'ArrowLeft' || e.key === 'a') keyState.left = true;
      if (e.key === 'ArrowRight' || e.key === 'd') keyState.right = true;
      emitDirection();
    });
    window.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowUp' || e.key === 'w') keyState.up = false;
      if (e.key === 'ArrowDown' || e.key === 's') keyState.down = false;
      if (e.key === 'ArrowLeft' || e.key === 'a') keyState.left = false;
      if (e.key === 'ArrowRight' || e.key === 'd') keyState.right = false;
      emitDirection();
    });

    window.addEventListener('load', () => {
      document.getElementById('sessionId').value = sessionId;
      setMul(1);

      socket.on('connect', () => {
        socket.emit('join-session', { sessionId, role: 'controller' });
      });
      socket.on('error-message', (msg) => setStatus(msg, true));
      socket.on('role-update', (data) => {
        hasController = data.hasController;
        setStatus(hasController ? 'Вы управляете мячом' : 'Ожидание контроллера...');
      });
      socket.on('ball-state', () => {
        // No canvas on controller; only sends input.
      });
      // Hook buttons
      document.querySelectorAll('[data-dir]').forEach(btn => {
        btn.addEventListener('click', () => {
          const [dx,dy] = btn.getAttribute('data-dir').split(',').map(Number);
          pressDir(dx,dy);
        });
      });
    });
  </script>
  </head>
  <body>
    <div class="wrap">
      <h2>Контроллер сессии <span class="kbd" id="sessionId"></span></h2>
      <p id="status" class="status">Подключение...</p>

      <div class="grid">
        <div class="card">
          <label>Скорость</label>
          <div class="row" style="gap:8px; align-items:center">
            <button class="kbd" onclick="setMul(1)">x1</button>
            <button class="kbd" onclick="setMul(2)">x2</button>
            <button class="kbd" onclick="setMul(3)">x3</button>
            <button class="kbd" onclick="setMul(5)">x5</button>
            <span id="speedVal" class="status">x1</span>
          </div>
        </div>

        <div class="card">
          <label>Управление</label>
          <div>Стрелки/WASD и быстрые направления:</div>
          <div style="display:grid; grid-template-columns:repeat(3,48px); gap:6px; margin-top:8px">
            <button class="kbd" data-dir="-1,-1">↖︎</button>
            <button class="kbd" data-dir="0,-1">▲</button>
            <button class="kbd" data-dir="1,-1">↗︎</button>
            <button class="kbd" data-dir="-1,0">◀︎</button>
            <div></div>
            <button class="kbd" data-dir="1,0">▶︎</button>
            <button class="kbd" data-dir="-1,1">↙︎</button>
            <button class="kbd" data-dir="0,1">▼</button>
            <button class="kbd" data-dir="1,1">↘︎</button>
          </div>
        </div>
      </div>
    </div>
  </body>
  </html>


