<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Controller</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 16px; background: #0f172a; color: #e2e8f0; }
    .wrap { max-width: 960px; margin: 0 auto; }
    .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .card { background: #111827; border: 1px solid #1f2937; border-radius: 12px; padding: 16px; }
    label { display: block; font-size: 14px; color: #94a3b8; margin-bottom: 6px; }
    input[type="text"], input[type="range"] { width: 100%; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; background: #1f2937; border: 1px solid #374151; border-bottom-width: 3px; border-radius: 6px; padding: 2px 6px; }
    .status { color: #93c5fd; }
    .err { color: #fca5a5; }
    .grid { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 16px; }
  </style>
  <script src="./config.js?v=4"></script>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
    const url = new URL(location.href);
    const sessionId = url.searchParams.get('sid');
    const serverUrl = url.searchParams.get('server') || window.SERVER_URL || '';
    const socket = io(serverUrl || undefined);

    let hasController = false;
    let keyState = { up:false, down:false, left:false, right:false };
    let mul = 1;

    function emitDirection() {
      const dirX = (keyState.right ? 1 : 0) + (keyState.left ? -1 : 0);
      const dirY = (keyState.down ? 1 : 0) + (keyState.up ? -1 : 0);
      socket.emit('control-update', { sessionId, input: { dirX, dirY, speedMultiplier: mul } });
    }
    function pressDir(dx, dy) {
      socket.emit('control-update', { sessionId, input: { dirX: dx, dirY: dy, speedMultiplier: mul } });
      updateDirectionDisplay(dx, dy);
    }
    
    function updateDirectionDisplay(dx, dy) {
      const display = document.getElementById('directionDisplay');
      if (dx === 1 && dy === 0) display.textContent = '‚ÜîÔ∏é –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å';
      else if (dx === -1 && dy === 0) display.textContent = '‚ÜîÔ∏é –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å';
      else if (dx === 0 && dy === 1) display.textContent = '‚ÜïÔ∏é –í–µ—Ä—Ç–∏–∫–∞–ª—å';
      else if (dx === 0 && dy === -1) display.textContent = '‚ÜïÔ∏é –í–µ—Ä—Ç–∏–∫–∞–ª—å';
      else if (dx === 1 && dy === 1) display.textContent = '‚ÜóÔ∏é‚ÜòÔ∏é –î–∏–∞–≥–æ–Ω–∞–ª—å L‚ÜíR';
      else if (dx === -1 && dy === 1) display.textContent = '‚ÜñÔ∏é‚ÜôÔ∏é –î–∏–∞–≥–æ–Ω–∞–ª—å R‚ÜíL';
      else display.textContent = '‚ÜîÔ∏é –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å';
    }
    function setMul(m) { mul = m; document.getElementById('speedVal').textContent = 'x' + m; }
    
    function resetSession() {
      socket.emit('control-update', { sessionId, input: { reset: true, pause: true } });
      setStatus('–°–µ—Å—Å–∏—è —Å–±—Ä–æ—à–µ–Ω–∞', false);
    }

    function setStatus(text, isError = false) {
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = isError ? 'err' : 'status';
    }

    window.addEventListener('keydown', (e) => {
      if (e.repeat) return;
      if (e.key === 'ArrowUp' || e.key === 'w') keyState.up = true;
      if (e.key === 'ArrowDown' || e.key === 's') keyState.down = true;
      if (e.key === 'ArrowLeft' || e.key === 'a') keyState.left = true;
      if (e.key === 'ArrowRight' || e.key === 'd') keyState.right = true;
      emitDirection();
    });
    window.addEventListener('keyup', (e) => {
      if (e.key === 'ArrowUp' || e.key === 'w') keyState.up = false;
      if (e.key === 'ArrowDown' || e.key === 's') keyState.down = false;
      if (e.key === 'ArrowLeft' || e.key === 'a') keyState.left = false;
      if (e.key === 'ArrowRight' || e.key === 'd') keyState.right = false;
      emitDirection();
    });

    window.addEventListener('load', () => {
      document.getElementById('sessionId').value = sessionId;
      setMul(1);

      socket.on('connect', () => {
        socket.emit('join-session', { sessionId, role: 'controller' });
        // Reset session when controller connects
        socket.emit('control-update', { sessionId, input: { reset: true, pause: true } });
      });
      socket.on('error-message', (msg) => setStatus(msg, true));
      socket.on('role-update', (data) => {
        hasController = data.hasController;
        setStatus(hasController ? '–í—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ –º—è—á–æ–º' : '–û–∂–∏–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞...');
      });
      socket.on('ball-state', () => {
        // No canvas on controller; only sends input.
      });
      socket.on('session-expired', (data) => {
        alert('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞ (15 –º–∏–Ω—É—Ç). –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é.');
        setStatus(data.message, true);
      });
      socket.on('viewer-joined', (data) => {
        setStatus('–ó—Ä–∏—Ç–µ–ª—å –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è –∫ —Å–µ—Å—Å–∏–∏!', false);
        // Show a temporary notification
        setTimeout(() => {
          setStatus('–í—ã —É–ø—Ä–∞–≤–ª—è–µ—Ç–µ –º—è—á–æ–º', false);
        }, 3000);
      });
      socket.on('viewer-left', (data) => {
        setStatus('–ó—Ä–∏—Ç–µ–ª—å –æ—Ç–∫–ª—é—á–∏–ª—Å—è. –°–µ—Å—Å–∏—è —Å–±—Ä–æ—à–µ–Ω–∞.', true);
        // Show a temporary notification
        setTimeout(() => {
          setStatus('–û–∂–∏–¥–∞–Ω–∏–µ –∑—Ä–∏—Ç–µ–ª—è...', false);
        }, 3000);
      });
      // Hook buttons
      document.querySelectorAll('[data-dir]').forEach(btn => {
        btn.addEventListener('click', () => {
          const [dx,dy] = btn.getAttribute('data-dir').split(',').map(Number);
          pressDir(dx,dy);
        });
      });
    });
  </script>
  </head>
  <body>
    <div class="wrap">
      <h2>–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å–µ—Å—Å–∏–∏ <span class="kbd" id="sessionId"></span></h2>
      <p id="status" class="status">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</p>

      <div class="grid">
        <div class="card">
          <label>–°–∫–æ—Ä–æ—Å—Ç—å</label>
          <div class="row" style="gap:8px; align-items:center">
            <button class="kbd" onclick="setMul(1)">x1</button>
            <button class="kbd" onclick="setMul(2)">x2</button>
            <button class="kbd" onclick="setMul(3)">x3</button>
            <button class="kbd" onclick="setMul(5)">x5</button>
            <span id="speedVal" class="status">x1</span>
          </div>
        </div>
        
        <div class="card">
          <label>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
          <div id="directionDisplay" class="status">‚ÜîÔ∏é –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å</div>
        </div>

        <div class="card">
          <label>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</label>
          <div>–°—Ç—Ä–µ–ª–∫–∏/WASD –∏ –±—ã—Å—Ç—Ä—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</div>
          <div style="display:grid; grid-template-columns:repeat(3,48px); gap:6px; margin-top:8px">
            <button class="kbd" data-dir="-1,-1">‚ÜñÔ∏é</button>
            <button class="kbd" data-dir="0,-1">‚ñ≤</button>
            <button class="kbd" data-dir="1,-1">‚ÜóÔ∏é</button>
            <button class="kbd" data-dir="-1,0">‚óÄÔ∏é</button>
            <div></div>
            <button class="kbd" data-dir="1,0">‚ñ∂Ô∏é</button>
            <button class="kbd" data-dir="-1,1">‚ÜôÔ∏é</button>
            <button class="kbd" data-dir="0,1">‚ñº</button>
            <button class="kbd" data-dir="1,1">‚ÜòÔ∏é</button>
          </div>
          <div style="margin-top:12px">
            <button class="btn" onclick="resetSession()" style="background:#dc2626; color:white; border:0; padding:8px 12px; border-radius:6px; cursor:pointer;">üîÑ –°–±—Ä–æ—Å–∏—Ç—å —Å–µ—Å—Å–∏—é</button>
          </div>
        </div>
      </div>
    </div>
  </body>
  </html>


